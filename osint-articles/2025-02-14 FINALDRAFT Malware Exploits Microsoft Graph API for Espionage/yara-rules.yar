rule Windows_Trojan_FinalDraft_ce03cf22 {
    meta:
        author = "Elastic Security"
        id = "ce03cf22-8016-44e0-8d09-fbe1b575f045"
        fingerprint = "856711354d1dd393faca657600631b78b6e53f8b7c24d3f2e5c7937b3f41d92d"
        creation_date = "2025-01-23"
        last_modified = "2025-02-04"
        threat_name = "Windows.Trojan.FinalDraft"
        reference_sample = "39e85de1b1121dc38a33eca97c41dbd9210124162c6d669d28480c833e059530"
        severity = 100
        arch_context = "x86"
        scan_context = "file, memory"
        license = "Elastic License v2"
        os = "windows"
    strings:
        $seq_derive_encryption_key = { 4D 6B C0 1F 48 0F BE 02 4C 03 C0 48 03 D7 49 3B D2 }
        $seq_decrypt_configuration = { 48 8B ?? 83 E0 ?? [4-9] 30 04 0A 48 [2] 48 81 ?? 9A 14 00 00 72 }
        $seq_magic = { 12 34 AB CD FF FF CD AB 34 12 }
        $str_injection_target_0 = "%c:\\Windows\\SysWOW64\\mspaint.exe" fullword
        $str_injection_target_1 = "%c:\\Windows\\System32\\mspaint.exe" fullword
        $str_injection_target_2 = "%c:\\Windows\\SysWOW64\\conhost.exe" fullword
        $str_injection_target_3 = "%c:\\Windows\\System32\\conhost.exe" fullword
        $str_active_connections_fmt_str = "%-7s%-34s%-34s%-13s%-7s" fullword
        $str_graph_parameters = "client_id=d3590ed6-52b3-4102-aeff-aad2292ab01c&grant_type=refresh" fullword
        $str_err_code = "err code: 0x%08x" fullword
    condition:
        5 of them
}

rule Linux_Trojan_FinalDraft_4ea5a204 {
    meta:
        author = "Elastic Security"
        id = "4ea5a204-5136-42c2-80f0-634368936296"
        fingerprint = "86cc29da59c8801d7443851e2c16f04d187de9705b16cc7fca553ea09baf0eb8"
        creation_date = "2025-01-23"
        last_modified = "2025-02-04"
        threat_name = "Linux.Trojan.FinalDraft"
        reference_sample = "83406905710e52f6af35b4b3c27549a12c28a628c492429d3a411fdb2d28cc8c"
        severity = 100
        arch_context = "x86"
        scan_context = "file, memory"
        license = "Elastic License v2"
        os = "linux"
    strings:
        $str_comm_option_1 = "CBindTcpTransChannel"
        $str_comm_option_2 = "CDnsTransChannel"
        $str_comm_option_3 = "CHttpTransChannel"
        $str_comm_option_4 = "CIcmpTransChannel"
        $str_comm_option_5 = "COutLookTransChannel"
        $str_comm_option_6 = "CReverseTcpTransChannel"
        $str_comm_option_7 = "CReverseUdpTransChannel"
        $str_comm_option_8 = "CWebTransChannel"
        $str_feature_1 = "%s?type=del&id=%s" fullword
        $str_feature_2 = "client_id=d3590ed6-52b3-4102-aeff-aad2292ab01c&grant_type=refresh_token" fullword
        $str_feature_3 = "/var/log/installlog.log.%s" fullword
        $str_feature_4 = "/mnt/hgfsdisk.log.%s" fullword
        $str_feature_5 = "%-10s %-25s %-25s %-15s" fullword
        $str_feature_6 = "%-20s %-10s %-10s %-10s %-30s" fullword
        $str_feature_7 = { 48 39 F2 74 ?? 48 0F BE 0A 48 FF C2 48 6B C0 ?? 48 01 C8 EB ?? }
    condition:
        (1 of ($str_comm_option*)) and (3 of ($str_feature_*))
}

rule Multi_Trojan_FinalDraft_81975d51 {
    meta:
        author = "Elastic Security"
        id = "81975d51-96e9-4a49-97ee-56e2c60e9702"
        fingerprint = "a2d5e2f472499ad6c5ff052eded73fa182bb20cecb9c3921f37bd779a2a77c9b"
        creation_date = "2024-12-03"
        last_modified = "2025-02-04"
        threat_name = "Multi.Trojan.FinalDraft"
        reference_sample = "fa2a6dbc83fe55df848dfcaaf3163f8aaefe0c9727b3ead1da6b9fa78b598f2b"
        severity = 100
        arch_context = "x86, arm64"
        scan_context = "file, memory"
        license = "Elastic License v2"
        os = "multi"
    strings:
        $a1 = "[-] socket() failed!"
        $a2 = "MailFolders/drafts/messages?$filter=Subject"
        $a3 = "{\"subject\":\"p_%llu\",\"body\":"
        $a4 = "COutLookTransChannel"
        $a5 = "CTransChannel"
        $a6 = "Chrome/40.0.2214.85 Safari/537.36"
    condition:
        3 of them
}

rule Multi_Trojan_FinalDraft_69deb8cd {
    meta:
        author = "Elastic Security"
        id = "69deb8cd-050b-4b92-86c2-ea54f836ce72"
        fingerprint = "3e48740092918896132e801ae4d850ef804f9dd6c8db96b80065224566c17819"
        creation_date = "2024-12-03"
        last_modified = "2025-02-04"
        threat_name = "Multi.Trojan.FinalDraft"
        reference_sample = "fa2a6dbc83fe55df848dfcaaf3163f8aaefe0c9727b3ead1da6b9fa78b598f2b"
        severity = 100
        arch_context = "x86, arm64"
        scan_context = "file, memory"
        license = "Elastic License v2"
        os = "multi"
    strings:
        $a1 = { 33 FF C7 44 24 20 3A 00 77 00 4C 8B F1 C7 44 24 24 74 00 66 00 48 83 C8 FF C7 44 24 28 62 00 62 00 C7 44 24 2C 71 00 00 00 48 8D 4C 24 20 }
        $a2 = { 48 81 EC B0 00 00 00 48 8B 05 00 5B 05 00 48 33 C4 48 89 84 24 A0 00 00 00 0F 57 C0 0F 11 44 24 48 4C 8B C2 48 8D 54 24 48 E8 00 0B 00 00 90 48 83 7C 24 50 00 0F 84 31 01 00 00 48 8B 7C 24 48 }
        $a3 = { 48 8D 7C 24 48 C6 43 40 00 48 C7 43 48 00 00 00 00 48 C7 43 50 00 00 00 00 48 89 43 68 48 8B ?? ?? ?? ?? 00 48 C7 43 58 00 00 00 00 C7 43 60 00 00 00 00 48 C7 43 70 00 00 00 00 C6 43 78 00 48 8D B0 FD 00 00 00 }
        $a4 = { 48 83 EC 58 B9 0D 00 00 00 BE 1E 00 00 00 64 48 8B 04 25 28 00 00 00 48 89 44 24 48 31 C0 48 8D 7C 24 14 48 C7 44 24 08 00 00 00 00 F3 AB 48 8D 7C 24 14 E8 }
    condition:
        any of them
}

rule Windows_Trojan_PathLoader_d62822f8 {
    meta:
        author = "Elastic Security"
        id = "d62822f8-202b-41f8-8c04-75cbc975fcdc"
        fingerprint = "dd257c5039fe21b73ac339275a26d9e677953c6dec11f4c2a5e82f76c8bbd2f0"
        creation_date = "2024-12-26"
        last_modified = "2025-02-04"
        threat_name = "Windows.Trojan.PathLoader"
        reference_sample = "9a11d6fcf76583f7f70ff55297fb550fed774b61f35ee2edd95cf6f959853bcf"
        severity = 100
        arch_context = "x86"
        scan_context = "file, memory"
        license = "Elastic License v2"
        os = "windows"
    strings:
        $debug_str = "[-] WinHttpSendRequest %d\n" ascii fullword
        $fnv_GetProcAddress = { 44 69 D2 93 01 00 01 45 84 C0 75 D4 41 81 FA 0C B5 82 01 }
        $peb_GetTickCount = { 48 3D 60 EA 00 00 0F 8F ?? ?? ?? ?? 65 48 8B 04 25 60 00 00 00 48 8B 40 18 48 8B 40 10 }
        $base64_http = { 36 31 34 38 35 32 33 30 36 33 34 }
    condition:
        3 of them
}

rule Windows_Trojan_GuidLoader_d3a30cec {
    meta:
        author = "Elastic Security"
        id = "d3a30cec-7145-41a9-b6a6-84ab02068a83"
        fingerprint = "609619490d36ddea6e4bc925278c5717048a2affa37dc81d346b841cdb45cab6"
        creation_date = "2025-01-10"
        last_modified = "2025-02-11"
        threat_name = "Windows.Trojan.GuidLoader"
        reference_sample = "f90420847e1f2378ac8c52463038724533a9183f02ce9ad025a6a10fd4327f12"
        severity = 100
        arch_context = "x86"
        scan_context = "file, memory"
        license = "Elastic License v2"
        os = "windows"
    strings:
        $seq1 = { 75 ?? B9 88 13 00 00 FF 15 ?? ?? ?? ?? 48 FF C? 48 83 F? }
        $seq2 = { 48 8B 55 ?? 48 83 FA 10 72 ?? 48 FF C2 48 8B 4D ?? 48 8B C1 48 81 FA 00 10 00 00 }
        $seq3 = { C1 E8 ?? 03 D0 0F BE C2 6B C8 ?? 41 0F B6 C0 41 FF C0 2A C1 04 ?? 41 30 41 ?? 41 83 F8 ?? 7C ?? }
        $seq4 = { 66 0F DB 15 ?? ?? 00 00 66 0F 67 D2 66 0F FC 15 ?? ?? 00 00 66 0F EF D0 66 0F 62 CB }
        $seq5 = "Download" ascii fullword
    condition:
        4 of them
}
