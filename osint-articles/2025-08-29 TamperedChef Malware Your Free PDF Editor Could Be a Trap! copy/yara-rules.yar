import "pe"

rule watchdog_antimalware_driver_64bit_ver10600
{
    meta:
        description = "Detects 64-bit, valid-signed WatchDog Antimalware driver, version 1.0.600"
        author = "Jiri Vinopal @ Check Point Research"
        hash = "12b3d8bc5cc1ea6e2acd741d8a80f56cf2a0a7ebfa0998e3f0743fcf83fabb9e"
    condition:
        // Detect PE
        uint16(0) == 0x5a4d and uint16(uint32(0x3c)) == 0x4550 and
        // Detect 64-bit Windows drivers
        uint16(uint32(0x3C) + 0x5c) == 0x0001 and uint16(uint32(0x3C) + 0x18) == 0x020b and
        // Detect OriginalFilename "amsdk.sys" and FileVersion "1.0.600"
        pe.version_info["OriginalFilename"] == "amsdk.sys" and pe.version_info["FileVersion"] == "1.0.600" and
        // Detect only signed drivers, not a real verification
        pe.number_of_signatures > 0 and for all i in (0..pe.number_of_signatures -1):
            (pe.signatures[i].verified)
}

rule watchdog_antimalware_driver_64bit_ver11100
{
    meta:
        description = "Detects 64-bit, valid-signed WatchDog Antimalware driver, version 1.1.100"
        author = "Jiri Vinopal @ Check Point Research"
        hash = "5af1dae21425dda8311a2044209c308525135e1733eeff5dd20649946c6e054c"
        hash = "0be8483c2ea42f1ce4c90e84ac474a4e7017bc6d682e06f96dc1e31922a07b10"
    condition:
        // Detect PE
        uint16(0) == 0x5a4d and uint16(uint32(0x3c)) == 0x4550 and
        // Detect 64-bit Windows drivers
        uint16(uint32(0x3C) + 0x5c) == 0x0001 and uint16(uint32(0x3C) + 0x18) == 0x020b and
        // Detect OriginalFilename "wamsdk.sys" and FileVersion "1.1.100"
        pe.version_info["OriginalFilename"] == "wamsdk.sys" and pe.version_info["FileVersion"] == "1.1.100" and
        // Detect only signed drivers, not a real verification
        pe.number_of_signatures > 0 and for all i in (0..pe.number_of_signatures -1):
            (pe.signatures[i].verified)
}


rule zam_advanced_malware_protection_driver_64bit_ver300000
{
    meta:
        description = "Detects 64-bit, valid-signed Advanced Malware Protection driver, version 3.0.0.000"
        author = "Jiri Vinopal @ Check Point Research"
        hash = "9c394dcab9f711e2bf585edf0d22d2210843885917d409ee56f22a4c24ad225e"
    condition:
        // Detect PE
        uint16(0) == 0x5a4d and uint16(uint32(0x3c)) == 0x4550 and
        // Detect 64-bit Windows drivers
        uint16(uint32(0x3C) + 0x5c) == 0x0001 and uint16(uint32(0x3C) + 0x18) == 0x020b and
        // Detect OriginalFilename "ZAM.exe" and FileVersion "3.0.0.000"
        pe.version_info["OriginalFilename"] == "ZAM.exe" and pe.version_info["FileVersion"] == "3.0.0.000" and
        // Detect only signed drivers, not a real verification
        pe.number_of_signatures > 0 and for all i in (0..pe.number_of_signatures -1):
            (pe.signatures[i].verified)
}